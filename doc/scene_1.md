# 场景一设计文档：基于本地代码仓的问答训练数据自动生成

## 1. 场景说明

场景一旨在构建一套**自动化的数据生成与处理框架**，通过分析本地代码仓的结构与业务规则，生成可直接用于大语言模型微调的**高质量问答对数据集**。

已完成：

* 从本地代码仓中解析代码结构
* 从解析结果中抽取业务规则
* 基于代码上下文与业务规则生成结构化问答对


---

## 2. 系统整体流程

场景一的数据生成流程分为三步：

1. **代码提取与结构化解析**
   使用 `./scripts/code_parser.py` 分析本地代码仓，生成统一的代码结构描述文件。

2. **业务规则提取**
   使用 `./scripts/parsed_rule_extractor.py` 从代码结构中抽取可用于生成问题的业务规则。

3. **问答对生成**
   使用 `./code/qa_generator.py`，基于业务规则与代码上下文生成问答对数据集。

数据流如下：

```
Local Repo
   ↓
code_parser.py
   ↓
parsed_code.json
   ↓
parsed_rule_extractor.py
   ↓
business_rule.json
   ↓
qa_generator.py
   ↓
QA Pairs (JSON)
```

---

## 3. 代码与规则数据结构

### 3.1 代码解析结果（parsed_code.json）

`parsed_code.json` 是对本地代码仓的结构化描述，主要包含：

* 仓库基本信息（repo_name）
* 文件级信息（路径、类型、行数）
* Python 文件中的：

  * 函数定义（含参数、装饰器、是否异步、代码片段）
  * 类定义（基类、方法、代码片段）
  * import 依赖
* API 端点信息（HTTP 方法、路由、对应函数）
* 模板文件（HTML）与配置文件信息

该文件为后续业务规则提取与代码引用提供**唯一数据源**。

---

### 3.2 业务规则结构（business_rule.json）

`business_rule.json` 由 `parsed_rule_extractor.py` 从代码结构中生成，核心作用是**定义可生成问题的最小业务单元**。

每条规则包含：

* `type`：规则类型（如 endpoint / function / model / class / template / import / config / file_structure）
* `name`：规则名称
* `file`：对应代码文件路径
* `code_snippet`：原始代码片段（如可获取）
* `question_types`：该规则支持的问题类型
* `metadata`：与规则相关的业务信息，例如：

  * HTTP 方法与路由
  * 函数参数与装饰器
  * 模型字段信息

业务规则是问答生成阶段的**直接输入**。

---

## 4. 场景一问答对训练结构定义

### 4.1 问答对象形式

每个问答对以 JSON 对象表示，核心字段包括：

* `question`：问题文本
* `answer`：答案文本
* `level`：技术层级（Level 1 / 2 / 3）
* `language`：语言类型（zh / en）
* `code_references`：代码上下文引用
* `data_processing_info`：数据处理相关信息（如适用）

---

### 4.2 代码上下文关联机制

**每个问答对必须可追溯到原始代码**，通过 `code_references` 字段实现：

* 文件路径（file_path）
* 代码组件描述（函数 / 类 / 路由 / 模板等）
* 代码片段（code_snippet，如可用）

该设计保证：

* 问答内容来源明确
* 训练数据可解释、可审计

---

### 4.3 业务规则集成

问答生成严格基于 `business_rule.json`：

* 问题围绕真实业务逻辑生成
* 包含 API 的 HTTP 方法、路由、参数等元数据
* 反映函数行为、模型结构与项目组织方式

不依赖人工规则编写。

---

### 4.4 技术层级划分

生成的问答对按技术理解深度分为三类：

* **Level 1：基础事实性问题**
  如：是什么、在哪个文件、包含多少模块

* **Level 2：功能理解性问题**
  如：如何工作、作用是什么、为何这样设计

* **Level 3：架构分析性问题**
  如：设计考量、潜在优化点、安全影响

层级信息作为训练数据的显式标签保留。

---

### 4.5 语言支持

* 无大语言模型支持时：

  * 生成基础中文问答对
* 有大语言模型支持时：

  * 支持英文问答对生成
  * 支持中英文混合数据集

语言类型由生成脚本参数控制。

---

## 5. 数据多样性与代表性保障

### 5.1 规则类型覆盖

系统自动遍历并覆盖所有已识别的规则类型，确保不同代码组件均参与问答生成。

### 5.2 技术层级分布控制

根据问题模板与关键词自动标注技术层级，保持不同层级问答对的合理比例。

### 5.3 多语言生成

支持单语言或双语数据集生成，以适配不同模型训练需求。

### 5.4 代码上下文采样

从代码仓中随机选择规则生成问答对，避免过度集中于单一文件或组件。

---

## 6. 使用方法

### 基础用法

```bash
# 生成问答对（默认中英文）
python ./code/qa_generator.py --rules ./data/business_rule.json --num 40

# 只生成中文问答对
python ./code/qa_generator.py --rules ./data/business_rule.json --lang zh --num 40

# 只生成英文问答对（需LLM支持）
python ./code/qa_generator.py --rules ./data/business_rule.json --lang en --num 40
```

生成结果为结构化 JSON 文件，可直接用于模型微调或进一步处理。

---

## 7. 说明

本设计文档对应**场景一 · 第一阶段实现**，仅描述当前系统已具备的能力，为后续场景扩展与训练策略升级提供稳定基础。
